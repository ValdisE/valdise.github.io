<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>op</title>
    <style>
        *{margin: 0; padding: 0}
        body{overflow-y: hidden}
        input{outline: none}
        img{display: none}
        #addPic{
            background-color: #FFF;
            color: #333;
            width: 300px;
            height: 50px;
            border-radius: 10px;
            border: 1.5px solid #000;
            position: fixed;
            top: 30px;
            right: 30px;
            cursor: pointer;
            line-height: 50px;
            text-align: center;
            font-size: 18px;
            z-index: 100;
            user-select: none;
            overflow: hidden;
        }
        #addPic:hover{
            background-color: #000;
            color: #FFF;
        }
        #addPic:active{
            transform: translate(1px, 1px);
        }
        #srcImgInputButton{display: none}
        #controlPanel{
            height: 600px; width: 300px;
            background-color: #FFF;
            position: fixed;
            top: 100px;
            right: 30px;
            border-radius: 10px;
            border: 1.5px solid #000;
            text-align: center;
        }
        #p5canvas{
            z-index: 1;
            border: 1.5px solid #000;
            position: relative;
            top: 20px;
            left: 20px;
        }
    </style>
</head>
<body>
<div id="addPic" onclick="document.getElementById('srcImgInputButton').click()">
    <span>添加图片</span>
    <input type="file" class="fileInputButton" id="srcImgInputButton" accept="image/*">
</div>

<div id="controlPanel">
    <form action="">
        <div>
            <label for="point_gap">点间距</label>
            <input id="point_gap" type=number>
        </div>
        <div>
            <label for="min_radius">最小半径</label>
            <input id="min_radius" type=number>
        </div>
        <div>
            <label for="max_radius">最大半径</label>
            <input id="max_radius" type=number>
        </div>
    </form>
</div>

<img id="srcImg" src="" alt="">

<script src="../js/jquery-3.3.1.min.js"></script>
<script src="../js/p5.js"></script>
<script src="../js/opencv.js"></script>
<script>
    // 变量
    let p5canvas = void 0;
    let canvasHeight = void 0, canvasWidth = void 0;
    let pointGap = 10;
    let pointNum_x = Math.ceil(window.innerWidth / pointGap);
    let pointNum_y = Math.ceil(window.innerHeight / pointGap);
    let pointMatrix = new Array(pointNum_y);


    // 初始化矩阵
    for (let i = 0; i < pointNum_y; i++) pointMatrix[i] = new Array(pointNum_x).fill(0);

    // 响应表单变化
    $('#point_gap').change(()=>{
        pointGap = $('#point_gap').val();
    });

    // 图像处理
    const srcImg = $('#srcImg')[0];           // 原图的img标签
    $('#srcImgInputButton').change(function(e) {
        srcImg.src = URL.createObjectURL(e.target.files[0]);    // 更新img标签
    });
    srcImg.onload = function () {
        let aspect_ratio = srcImg.width / srcImg.height;        // 图像宽高比
        console.log(srcImg);
        srcImg.width = window.innerWidth;
        srcImg.height = srcImg.width / aspect_ratio;

        // 调整宽高，适应屏幕
        while (srcImg.height > window.innerHeight || srcImg.width > window.innerWidth) {
            if (srcImg.width > window.innerWidth) {
                srcImg.width = window.innerWidth * 0.9;
                srcImg.height = srcImg.width / aspect_ratio;
            }
            else if (srcImg.height > window.innerHeight) {
                srcImg.height = window.innerHeight * 0.9;
                srcImg.width = srcImg.height * aspect_ratio;
            }
        }

        // 实际像素操作
        let srcMat = cv.imread(srcImg);
        cv.cvtColor(srcMat, srcMat, cv.COLOR_RGBA2GRAY, 0);
        for (let i = 0; i < pointNum_y; i++) for (let j = 0; j < pointNum_x; j++) pointMatrix[i][j] = 0;
        for(let i = 0, r = 0; r < srcMat.rows; r += pointGap, i++)              // 行
            for (let j = 0, c = 0; c < srcMat.cols; c += pointGap, j++) {       // 列
                let grayData = srcMat.ucharPtr(r, c)[0];                        // 灰度采样
                pointMatrix[i][j] = ((255 - grayData) / 255) * pointGap;        // 灰度映射为点的大小
            }
    };

    const updateCanvasFromMatrix = function (matrix) {
        for (let i = 0; i < pointNum_x; i++)
            for (let j = 0; j < pointNum_y; j++) {
                strokeWeight(matrix[j][i]);
                point(i * pointGap, j * pointGap);
            }
    };

    function setup() {
        p5canvas = createCanvas(window.innerWidth - 400, window.innerHeight - 40);
        p5canvas.id('p5canvas');
        frameRate(60);
        updateCanvasFromMatrix(pointMatrix);
    }
    
    function draw() {
        updateCanvasFromMatrix(pointMatrix);
    }
</script>
</body>
</html>